package com.cg.controller;

import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

import com.cg.DTO.ProductDTO;
import com.cg.exception.ResourceNotFoundException;
import com.cg.model.Category;
import com.cg.model.Product;
import com.cg.service.CategoryService;
import com.cg.service.ProductService;

import jakarta.validation.Valid;

@Controller
@RequestMapping("/api")
public class ProductController {
	@Autowired
	ProductService service;
	@Autowired
	CategoryService categoryservice;
 
	
	
//	@GetMapping("/hello")
//	public String hello() {
//		return "hello String Rest";
//	}
	
	//http://localhost:8080/api/products
	//@GetMapping("/products")
	@GetMapping( "/list")
	public String listAllProducts(Model model){
		//model.addAttribute("products",service.findAllProducts());
		model.addAttribute("products",service.getproductWithCategory());
		return "product/list-product"; 
	}
	
	 // Show Add Product form
    @GetMapping("/add")
    public String showAddProductForm(Model model) {
        model.addAttribute("product", new Product());
        List<Category> categories = categoryservice.getAllCategory();
        System.out.println("All categories are listed"+ categories);
        model.addAttribute("categories",categories);
        return "product/add-product";
    }
    
    // Handle form submission
    @PostMapping("/add")
    public String createProduct(
            @Valid @ModelAttribute("product") Product product,
            BindingResult result,
            @RequestParam int categoryId ) {

        if (result.hasErrors()) {
            result.getAllErrors()
                  .forEach(error -> System.out.println(error.getDefaultMessage()));
            return "product/add-product";
        }
        Optional<Category> category = categoryservice.getCategoryById(categoryId);
        product.setCategory(category.get());
        service.createProduct(product);
        return "redirect:/api/list";
    }
  
// // Edit page
//    @GetMapping("/edit/{id}")
//    public String editProduct(@PathVariable int id, Model model)
//            throws ResourceNotFoundException {
//
//        Product product = service.findProductById(id)
//                .orElseThrow(() ->
//                        new ResourceNotFoundException("Product not found with id: " + id));
//        
//        List<Category> categories = categoryservice.getAllCategory();
//        System.out.println("All categories are listed"+ categories);
//        model.addAttribute("categories",categories);
//
//        model.addAttribute("product", product);
//        return "product/edit-product";
//    }
//    
    
    
    
 // Edit page using DTO
    @GetMapping("/edit/{id}")
    public String editProduct(@PathVariable int id, Model model)
            throws ResourceNotFoundException {

        Product product = service.findProductById(id)
                .orElseThrow(() ->
                        new ResourceNotFoundException("Product not found with id: " + id));
        ProductDTO dto = new ProductDTO();
        dto.setId(product.getId());
        dto.setPname(product.getPname());
        dto.setPrice(product.getPrice());
        dto.setCategoryid(product.getCategory().getId());
        dto.setCategoryname(product.getCategory().getCname());

        
        List<Category> categories = categoryservice.getAllCategory();
        System.out.println("All categories are listed"+ categories);
        model.addAttribute("categories",categories);

        model.addAttribute("product", dto);
        return "product/edit-product";
    }
    
    
    
    
 // Update
    @PostMapping("/update/{id}")
    public String updateProduct(@PathVariable int id,
                                @ModelAttribute("product") Product product,
                                @RequestParam int categoryId)
            throws ResourceNotFoundException {
    	Optional<Category> category = categoryservice.getCategoryById(categoryId);
        product.setCategory(category.get());

        service.updateProduct(id, product);
        return "redirect:/api/list";
    }
    
 // Delete
    @GetMapping("/delete/{id}")
    public String deleteProduct(@PathVariable int id)
            throws ResourceNotFoundException {

        service.deleteProduct(id);
        return "redirect:/api/list";
    }
	
	
//	@GetMapping("/product/id")  //http://localhost:8080/api/product/1
//	public Product getProductById(@PathVariable int id) throws ResourceNotFoundException {
//		Optional<Product> product = service.findProductById(id);
//		product.orElseThrow(() -> new ResourceNotFoundException("Product not found for this id :: " + id));	
//		return product.get(); 
//	}
//	@GetMapping("/product")  //http://localhost:8080/api/product?id=1
//	public Product getProductByIdUsingKey(@RequestParam int id) {
//		Optional<Product> product = service.findProductById(id);
//		return product.get(); 
//	}
//	
//	@PostMapping("/product")
//	public Product createProduct(@RequestBody Product product) {
//		return service.createProduct(product);
//		
//	}
//	
//	@DeleteMapping("/delete")
//	public void deleteProduct(@RequestParam int id) {
//		service.deleteProduct(id);
//		
//	}
//	
//	@PutMapping("/update")
//	public Product updateProduct(@RequestBody Product product) {
//		return service.updateProduct(product);
//	}
//	
//	@GetMapping("/count/{pname}")
//	public ResponseEntity<Long> countProductByName(@PathVariable String pname){
//		System.out.println("Count from service");
//		Long count = service.countProductByName(pname);
//		return ResponseEntity.ok(count);
//		
//	}
}
